<!-- Manage Audience Section -->

<!-- <button class="btn btn-outline-primary" (click)="showAudienceModal = true">
  See All Audiences
</button> -->

<!-- Manage Offers Section -->
<button (click)="openCreateModal()">Create Offer</button>
<!-- <div *ngFor="let offer of offers" (click)="offer.id && viewOffer(offer.id)">
  <p>{{ offer.name }}</p>
</div> -->
<!-- <table class="offers-table">
  <thead>
    <tr>
      <th>Offer Name</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let offer of offers">
      <td>{{ offer.name }}</td>
      <td>
        <button (click)="viewOffer(offer.id)" title="Edit Offer">‚úèÔ∏è</button>
        <button (click)="confirmDelete(offer)" title="Delete Offer">üóëÔ∏è</button>
      </td>
    </tr>
  </tbody>
</table> -->
<div class="offers-container">
  <!-- Left Column: Offers Table -->
  <div class="offers-list">
    <table class="offers-table">
      <thead>
        <tr>
          <th>Offer Name</th>
          <th>Actions</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let offer of offers">
          <td>{{ offer.name }}</td>
          <td>
            <button (click)="viewOffer(offer.id)" title="Edit Offer">‚úèÔ∏è</button>
            <button (click)="confirmDelete(offer)" title="Delete Offer">
              üóëÔ∏è
            </button>
          </td>
          <td>
            <mat-slide-toggle
              [checked]="offer.active"
              (change)="toggleOfferStatus(offer)"
              color="primary"
            >
            </mat-slide-toggle>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Right Column: Offer Image -->
  <div class="offer-image">
    <img src="assets/offer.jpg" alt="Offer Image" />
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeletePopup" class="modal-backdrop">
  <div class="modal">
    <p>
      Are you sure you want to delete <strong>{{ selectedOffer?.name }}</strong
      >?
    </p>
    <div class="actions">
      <button (click)="deleteOffer(selectedOffer!.id)">Delete</button>
      <button (click)="showDeletePopup = false">Cancel</button>
    </div>
  </div>
</div>

<!-- View Offer Modal -->
<!-- <div *ngIf="selectedOffer">
  <h4>Offer Details: {{ selectedOffer.name }}</h4>
  <pre>{{ selectedOffer | json }}</pre>
</div> -->

<!-- Create/Edit Offer Modal -->
<div *ngIf="showCreateModal" class="modal-backdrop">
  <form [formGroup]="offerForm" class="modal-box" (ngSubmit)="saveOffer()">
    <h3>{{ editingOfferId ? "Edit Offer" : "Create Offer" }}</h3>

    <!-- Form validation error message -->
    <div *ngIf="formSubmitted && offerForm.invalid" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
      <p class="font-bold">Please fix the following errors:</p>
      <ul class="mt-2 list-disc list-inside text-sm">
        <li *ngIf="offerForm.get('name')?.invalid">Offer name is required</li>
        <li *ngIf="getTimeGroup().get('start')?.invalid">Start time is required</li>
        <li *ngIf="getTimeGroup().get('end')?.invalid">End time is required</li>
      </ul>
    </div>

    <!-- <label>Audience</label>
    <select [(ngModel)]="newOffer.audienceId">
      <option *ngFor="let a of audiences" [value]="a.id">{{ a.name }}</option>
      <input formControlName="name" />
    </select> -->

    <!-- Offer Name -->
     <hr/>
  <div class="mt-2">
      <h4 class="font-semibold mb-2">Offer Name</h4>
    <input formControlName="name" 
      [class.border-red-500]="formSubmitted && offerForm.get('name')?.invalid" />
    <p *ngIf="formSubmitted && offerForm.get('name')?.hasError('required')" class="text-red-500 text-sm mt-1">
      Offer name is required
    </p>
    </div>
  

    <!-- Items -->
    <div class="mb-4">
      <h4 class="font-semibold mb-2">Select Items</h4>
      <div *ngFor="let item of items" class="flex items-center mb-2">
        <label class="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            (change)="toggleArrayValue('item_ids', item.id, $event)"
            [checked]="offerForm.value.item_ids.includes(item.id)"
          />
          <span>{{ item.descriptor.name }}</span>
        </label>
      </div>
    </div>

    <!-- Locations -->
    <div class="mb-4">
      <h4 class="font-semibold mb-2">Select Locations</h4>
      <div *ngFor="let location of locations" class="flex items-center mb-2">
        <label class="flex items-center space-x-2 cursor-pointer">
          <input
            type="checkbox"
            (change)="toggleArrayValue('location_ids', location.id, $event)"
            [checked]="offerForm.value.location_ids.includes(location.id)"
          />
          {{ location.address.city }} - {{ location.address.locality }}
        </label>
      </div>
    </div>

    <!-- Timings  -->
    <div class="mt-4" [formGroup]="getTimeGroup()">
      <h4 class="font-semibold mb-2">Timings</h4>

      <div class="row">
        <div class="col">
          <label>From</label>
          <input type="datetime-local" formControlName="start" />
        </div>
        <div class="col">
          <label>To</label>
          <input type="datetime-local" formControlName="end" />
        </div>
      </div>
    </div>
   
    <!-- Tags -->
     <!-- 1. Offer Type Dropdown -->
  <div class="mt-4">
    <h4 class="font-semibold mb-2">Offer Type</h4>
    <select class="form-select" formControlName="offerType" (change)="onTypeChange($event)">
      <option value="" disabled>-- Select an Offer --</option>
      @for (option of offerOptions; track option) {
        <option [value]="option">{{ option }}</option>
      }
    </select>
  </div>

  <!-- 2. Dynamic Groups (Qualifier, Benefit, etc.) -->
  <div *ngFor="let group of groupList" [formGroup]="getTagGroup(group)" class="mt-6">
    
    <!-- Only show qualifier and benefit if an offer type is selected, always show meta -->
    <ng-container *ngIf="selectedOffer">
    <h4 class="font-semibold mb-2">{{ group | titlecase }}</h4>

    <div *ngFor="let code of tagConstants[group]">
      <!-- Show field only if it belongs to the selected Offer Type -->
      <ng-container *ngIf="shouldShowField(group, code.label)">
        <div class="flex items-center mt-2">
          <label class="text-sm font-medium">
            {{ labelMap[code.label] || code.label }}
            <span *ngIf="getTagGroup(group).get(code.label)?.hasError('required')" class="text-red-500">*</span>
          </label>
          <img
            src="../../../assets/circle-help.svg"
            class="w-4 h-4 ml-2 cursor-pointer"
            [matTooltip]="getTooltip(code.label)"
            matTooltipPosition="after"
          />
        </div>

        <!-- Text Input -->
        <input 
          *ngIf="code.type === 'text'" 
          [formControlName]="code.label"
          [type]="code.subtype === 'number' ? 'number' : code.subtype === 'decimal' ? 'number' : 'text'"
          [attr.step]="code.subtype === 'decimal' ? '0.01' : '1'"
          class="border rounded p-2 w-full mt-1"
          [class.border-red-500]="getTagGroup(group).get(code.label)?.invalid && getTagGroup(group).get(code.label)?.touched"
        />
        <p *ngIf="getTagGroup(group).get(code.label)?.hasError('required') && getTagGroup(group).get(code.label)?.touched" class="text-red-500 text-sm mt-1">
          This field is required
        </p>

        <!-- Radio/Select Selection -->
        <div *ngIf="code.type === 'radio' && code.values" class="mt-1">
          <select 
            [formControlName]="code.label" 
            class="form-select border rounded p-2 w-full"
            [class.border-red-500]="getTagGroup(group).get(code.label)?.invalid && getTagGroup(group).get(code.label)?.touched"
          >
            <option *ngFor="let value of code.values" [value]="value">
              {{ value }}
            </option>
          </select>
          <p *ngIf="getTagGroup(group).get(code.label)?.hasError('required') && getTagGroup(group).get(code.label)?.touched" class="text-red-500 text-sm mt-1">
            This field is required
          </p>
        </div>
      </ng-container>
    </div>
    </ng-container>
  </div>

    <button type="submit" [disabled]="offerForm.invalid">{{ editingOfferId ? "Update" : "Save" }}</button>
    
    <button type="button" (click)="resetForm()">Cancel</button>
  </form>
</div>

<!-- Audience Modal -->
<div *ngIf="showAudienceModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-audience-header">
      <h3 class="modal-title">All Audience Segments</h3>
      <button class="close-btn" (click)="showAudienceModal = false">√ó</button>
      <div><button>Add new Audience</button></div>
    </div>

    <mat-accordion>
      <mat-expansion-panel *ngFor="let audience of audiences">
        <mat-expansion-panel-header>
          <mat-panel-title>{{ audience.name }}</mat-panel-title>
        </mat-expansion-panel-header>
        <!-- <pre>{{ audience.rules | json }}</pre> -->
        <div class="rule-item" *ngFor="let key of getRuleKeys(audience.rules)">
          <strong>{{ formatLabel(key) }}:</strong>
          {{ formatValue(audience.rules[key]) }}
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
</div>
